{%- comment -%}
Password page gate: graffiti canvas + email capture.
Unlocks password modal only after successful email submit.
Sends graffiti as a data URL in the contact email body.
{%- endcomment -%}

<!-- Required assets for graffiti functionality -->
{{ 'graffiti.css' | asset_url | stylesheet_tag }}
<script src="{{ 'graffiti.js' | asset_url }}"></script>

<!-- Silkscreen font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Silkscreen:wght@400;700&display=swap" rel="stylesheet">

<script>
// Ensure body has password class for graffiti CSS to work
document.addEventListener('DOMContentLoaded', function() {
  if (!document.body.classList.contains('password')) {
    document.body.classList.add('password');
  }
  console.log('Graffiti gate loaded, body classes:', document.body.className);
  
  // Debug graffiti initialization
  const gate = document.querySelector('[data-graffiti-gate]');
  const canvas = document.getElementById('graffiti-canvas');
  console.log('Graffiti gate element:', gate);
  console.log('Canvas element:', canvas);
  console.log('Graffiti script loaded:', typeof window.__graffiti);
  
  // Check all required elements
  const colors = document.querySelectorAll('.graffiti-color');
  const sizeInput = document.getElementById('graffiti-size');
  const undoBtn = document.getElementById('graffiti-undo');
  const clearBtn = document.getElementById('graffiti-clear');
  const toggleBtn = document.getElementById('graffiti-toggle');
  
  console.log('Required elements check:');
  console.log('- Colors:', colors.length);
  console.log('- Size input:', !!sizeInput);
  console.log('- Undo button:', !!undoBtn);
  console.log('- Clear button:', !!clearBtn);
  console.log('- Toggle button:', !!toggleBtn);
  
  // Check if canvas context is available
  if (canvas) {
    const ctx = canvas.getContext('2d');
    console.log('Canvas context:', !!ctx);
    console.log('Canvas dimensions:', canvas.width + 'x' + canvas.height);
  }
  
  // Force initialize if graffiti.js didn't auto-init
  setTimeout(function() {
    if (!window.__graffiti && gate && canvas) {
      console.log('Manually initializing graffiti...');
      // Check if the Graffiti class exists
      console.log('Available on window:', Object.keys(window).filter(k => k.toLowerCase().includes('graffiti')));
    }
  }, 2000);
});
</script>

<section class="graffiti-gate color-{{ section.settings.color_scheme }} gradient" data-graffiti-gate data-bg-rotate="false" data-bg-interval="{{ section.settings.bg_interval }}">
  <div class="graffiti-gate__bg concrete-bg" aria-hidden="true">
    {%- assign imgs = '' -%}
    {%- if section.settings.bg_image_1 != blank -%}
      {%- assign imgs = imgs | append: '1' -%}
    {%- endif -%}
    {%- if section.settings.bg_image_2 != blank -%}
      {%- assign imgs = imgs | append: '2' -%}
    {%- endif -%}
    {%- if section.settings.bg_image_3 != blank -%}
      {%- assign imgs = imgs | append: '3' -%}
    {%- endif -%}
    {%- assign imgs_count = imgs | size -%}

    {%- if imgs != '' -%}
      {%- assign first_active = '' -%}
      {%- if section.settings.bg_image_1 != blank and first_active == '' -%}{%- assign first_active = '1' -%}{%- endif -%}
      {%- if section.settings.bg_image_2 != blank and first_active == '' -%}{%- assign first_active = '2' -%}{%- endif -%}
      {%- if section.settings.bg_image_3 != blank and first_active == '' -%}{%- assign first_active = '3' -%}{%- endif -%}

      {%- if section.settings.bg_image_1 != blank -%}
        {%- assign cls1 = 'graffiti-gate__img' -%}
        {%- if first_active == '1' -%}{%- assign cls1 = cls1 | append: ' is-active' -%}{%- endif -%}
        {{ section.settings.bg_image_1 | image_url: width: 2400 | image_tag: class: cls1, loading: 'eager', decoding: 'async' }}
      {%- endif -%}
      {%- if section.settings.bg_image_2 != blank -%}
        {%- assign cls2 = 'graffiti-gate__img' -%}
        {%- if first_active == '2' -%}{%- assign cls2 = cls2 | append: ' is-active' -%}{%- endif -%}
        {{ section.settings.bg_image_2 | image_url: width: 2400 | image_tag: class: cls2, loading: 'lazy', decoding: 'async' }}
      {%- endif -%}
      {%- if section.settings.bg_image_3 != blank -%}
        {%- assign cls3 = 'graffiti-gate__img' -%}
        {%- if first_active == '3' -%}{%- assign cls3 = cls3 | append: ' is-active' -%}{%- endif -%}
        {{ section.settings.bg_image_3 | image_url: width: 2400 | image_tag: class: cls3, loading: 'lazy', decoding: 'async' }}
      {%- endif -%}
    {%- endif -%}
    
    {%- comment -%} Always load default textures as fallback/additional options {%- endcomment -%}
    {%- unless section.settings.bg_image_1 != blank -%}
      <img class="graffiti-gate__img{% unless imgs != '' %} is-active{% endunless %}" src="{{ 'your-texture.jpg' | asset_url }}" alt="Concrete wall texture" width="2400" height="1600" loading="eager" decoding="async" />
    {%- endunless -%}
    {%- unless section.settings.bg_image_2 != blank -%}
      <img class="graffiti-gate__img" src="{{ 'your_texture02.jpg' | asset_url }}" alt="Wall texture 2" width="2400" height="1600" loading="lazy" decoding="async" />
    {%- endunless -%}
    {%- unless section.settings.bg_image_3 != blank -%}
      <img class="graffiti-gate__img" src="{{ 'your_texture03.jpg' | asset_url }}" alt="Wall texture 3" width="2400" height="1600" loading="lazy" decoding="async" />
    {%- endunless -%}
  </div>
  <canvas id="graffiti-canvas" class="graffiti-gate__canvas" role="img" aria-label="Graffiti drawing area"></canvas>

  <div class="graffiti-gate__ui">
    <div class="graffiti-copy graffiti-hideable">
      <h3 class="graffiti-h3">{{ section.settings.heading | default: 'Share your work' }}</h3>
      <h3 class="graffiti-h3">{{ section.settings.subheading | default: '@radiohighdigital' }}</h3>
    </div>

    <div class="graffiti-gate__group graffiti-gate__group--colors graffiti-hideable" aria-label="Choose color">
      {%- assign colors = section.settings.palette | split: ',' -%}
      {%- for c in colors -%}
        {%- assign c_trim = c | strip -%}
        <button type="button" class="graffiti-color" style="--c: {{ c_trim }}" data-color="{{ c_trim }}" aria-pressed="{% if forloop.first %}true{% else %}false{% endif %}" aria-label="Color {{ c_trim }}"></button>
      {%- endfor -%}
    </div>

    <div class="graffiti-gate__group graffiti-size-wrap graffiti-hideable" aria-label="Cap size">
      <label id="graffiti-size-label" for="graffiti-size" class="graffiti-label">Cap Size: <span id="graffiti-size-display">16</span></label>
      <input id="graffiti-size" class="graffiti-size" type="range" min="6" max="48" value="16" step="1" aria-labelledby="graffiti-size-label graffiti-size-display" />
      <span id="graffiti-cap-preview" class="graffiti-cap-preview" aria-hidden="true"></span>
    </div>

    <div class="graffiti-gate__group graffiti-hideable">
      <button id="graffiti-undo" type="button" class="graffiti-btn">Undo</button>
      <button id="graffiti-clear" type="button" class="graffiti-btn">Clear</button>
      {%- assign bg_count = imgs_count -%}
      {%- if bg_count == 0 -%}{%- assign bg_count = 3 -%}{%- endif -%}
      {%- if bg_count > 1 -%}
      <button id="graffiti-bg-next" type="button" class="graffiti-btn" aria-label="Switch background">Next Background</button>
      {%- endif -%}
    </div>
    <button type="button" id="graffiti-toggle" class="graffiti-toggle" aria-pressed="false" aria-label="Hide controls">Hide Controls</button>
  </div>
</section>

{% schema %}
{
  "name": "Password Page",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Main heading",
      "default": "Share your work"
    },
    {
      "type": "text",
      "id": "subheading", 
      "label": "Subheading",
      "default": "@radiohighdigital"
    },
    {
      "type": "image_picker",
      "id": "bg_image_1",
      "label": "Background image 1"
    },
    {
      "type": "image_picker",
      "id": "bg_image_2",
      "label": "Background image 2"
    },
    {
      "type": "image_picker",
      "id": "bg_image_3",
      "label": "Background image 3"
    },
    {
      "type": "text",
      "id": "palette",
      "default": "#000000,#ffffff,#c0c0c0,#ff0000,#ff69b4,#1e90ff",
      "label": "Palette (comma-separated)"
    }
  ],
  "presets": [
    {
      "name": "Password Page"
    }
  ]
}
{% endschema %}
