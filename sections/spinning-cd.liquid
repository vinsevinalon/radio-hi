<style>
  .spinning-cd {
    display: inline-block;
    width: var(--cd-size, 200px);
    height: var(--cd-size, 200px);
    line-height: 0;
  }

  .spinning-cd__img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    will-change: transform;
    transform: translateZ(0);
  }

  .spinning-cd--left { justify-self: start; }
  .spinning-cd--center { margin-left: auto; margin-right: auto; display: block; }
  .spinning-cd--right { justify-self: end; margin-left: auto; display: block; }

  .spinning-cd__wrap {
    display: var(--cd-display, block);
  }

  /* Fixed positioning: top-right on desktop, bottom-right on mobile */
  #SpinningCD-{{ section.id }} {
    position: fixed;
    right: 16px;
    z-index: 40;
  }
  @media screen and (min-width: 990px) {
    #SpinningCD-{{ section.id }} { top: 16px; bottom: auto; }
  }
  @media screen and (max-width: 989px) {
    #SpinningCD-{{ section.id }} { bottom: 16px; top: auto; }
  }
</style>

{%- assign cd_size = section.settings.size | default: 200 -%}
{%- assign cd_speed = section.settings.speed | default: 0.2 -%}

<div id="SpinningCD-{{ section.id }}" class="spinning-cd__wrap">
  <div class="spinning-cd spinning-cd--{{ section.settings.alignment }}"
       style="--cd-size: {{ cd_size }}px;"
       data-speed="{{ cd_speed }}">
    {%- if section.settings.image != blank -%}
      {%- assign alt_text = section.settings.alt | default: section.settings.image.alt | default: shop.name | escape -%}
      {%- assign img_height = cd_size | divided_by: section.settings.image.aspect_ratio | round -%}
      {{ section.settings.image | image_url: width: cd_size | image_tag:
        class: 'spinning-cd__img',
        alt: alt_text,
        loading: 'lazy',
        width: cd_size,
        height: img_height
      }}
    {%- else -%}
      <div class="spinning-cd__img" style="background: repeating-conic-gradient(#ddd 0% 25%, #f7f7f7 0% 50%); border-radius: 50%;"></div>
    {%- endif -%}
  </div>
</div>

<script>
  (function() {
    const root = document.getElementById('SpinningCD-{{ section.id }}');
    if (!root) return;
    const cd = root.querySelector('.spinning-cd__img');
    if (!cd) return;

    const container = root.querySelector('.spinning-cd');
    const speed = parseFloat(container.getAttribute('data-speed') || '0.2');

    let lastY = window.scrollY || window.pageYOffset || 0;
    let angle = 0;
    let ticking = false;
    let inView = true;

    // Pause work when out of view
    const io = ('IntersectionObserver' in window) ? new IntersectionObserver((entries) => {
      inView = entries[0].isIntersecting;
    }, { threshold: 0 }) : null;
    if (io) io.observe(container);

    function onScroll() {
      if (!inView) { lastY = window.scrollY; return; }
      const y = window.scrollY || window.pageYOffset || 0;
      const dy = y - lastY;
      lastY = y;
      angle += dy * speed;
      if (!ticking) {
        ticking = true;
        requestAnimationFrame(() => {
          cd.style.transform = `rotate(${angle}deg)`;
          ticking = false;
        });
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true });

    // Ensure editor toggles re-init correctly
    document.addEventListener('shopify:section:unload', function(e) {
      if (e.detail && e.detail.sectionId === '{{ section.id }}') {
        window.removeEventListener('scroll', onScroll);
        if (io) io.disconnect();
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Spinning CD",
  "tag": "section",
  "class": "section section-spinning-cd",
  "settings": [
    { "type": "image_picker", "id": "image", "label": "CD image (PNG)" },
    { "type": "text", "id": "alt", "label": "Alt text", "default": "CD" },
    { "type": "range", "id": "size", "label": "Size", "min": 80, "max": 500, "step": 10, "unit": "px", "default": 200 },
    { "type": "range", "id": "speed", "label": "Spin speed", "min": 0.1, "max": 1.0, "step": 0.1, "default": 0.2 },
    { "type": "select", "id": "alignment", "label": "Alignment", "default": "center", "options": [
      { "value": "left", "label": "Left" },
      { "value": "center", "label": "Center" },
      { "value": "right", "label": "Right" }
    ]}
  ],
  "presets": [
    { "name": "Spinning CD", "category": "Media" }
  ]
}
{% endschema %}
